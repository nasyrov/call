# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
pnpm dev           # Start dev server with Turbopack
pnpm build         # Production build
pnpm lint          # ESLint only
pnpm lint:fix      # ESLint with auto-fix
pnpm typecheck     # TypeScript type checking
pnpm format        # Check formatting with Prettier
pnpm format:fix    # Fix formatting with Prettier
pnpm knip          # Check for unused files/exports/dependencies

# Database (Drizzle + PostgreSQL)
pnpm db:auth       # Regenerate auth schema from Better Auth config
pnpm db:generate   # Generate migrations from schema changes
pnpm db:migrate    # Run migrations
pnpm db:push       # Push schema directly (dev only)
pnpm db:studio     # Open Drizzle Studio GUI

# Start local PostgreSQL
docker compose up -d
```

## Architecture

Next.js 15 app using T3 Stack pattern with App Router, Better Auth, Drizzle ORM, and shadcn/ui.

### Path Aliases
- `~/` maps to `./src/`

### Route Groups

**`(auth)`** - Public authentication pages (static)
- `/login`, `/register`, `/password/forgot`, `/password/reset`
- Each page has colocated `_components/` and `_validation/` folders
- Forms use react-hook-form with zod validation via shadcn Form component
- Client components using Better Auth client methods

**`(dashboard)`** - Protected pages (dynamic)
- `/` - Dashboard home (protected by middleware + server-side session check)

### Authentication Flow

1. **Middleware** (`src/middleware.ts`) - Uses `getCookieCache` from `better-auth/cookies` for session validation with 5-minute cookie cache
2. **Server config** (`src/server/better-auth/config.ts`) - Better Auth with email/password, drizzle adapter
3. **API routes** (`src/app/api/auth/[...all]/route.ts`) - Catch-all for Better Auth endpoints
4. **Server utility** (`src/server/better-auth/server.ts`) - `getSession()` for server components
5. **Client utility** (`src/server/better-auth/client.ts`) - `authClient` for client components

### UI Components

shadcn/ui components in `src/components/ui/`. Key patterns:
- Forms: `Form`, `FormField`, `FormItem`, `FormLabel`, `FormControl`, `FormMessage`
- Alerts: `Alert` with `variant="destructive"` for errors, icons from lucide-react
- Theming: next-themes with `ThemeProvider` in root layout, all colors use semantic tokens

### Database

- Auth tables: `users`, `sessions`, `accounts`, `verifications` (plural names)
- IDs: UUID type with `gen_random_uuid()` default
- `src/server/db/schema/auth.ts` is auto-generated by `pnpm db:auth` - do not edit manually

### Environment Variables

Required in `src/env.js`:
- `DATABASE_URL` - PostgreSQL connection string
- `BETTER_AUTH_SECRET` - Required in production

Set `SKIP_ENV_VALIDATION=1` to skip validation during builds.

## Code Style

- Use type-only imports: `import type { Foo } from ...`
- Tailwind utility functions (`cn`, `cva`) configured in Prettier for class sorting
- ESLint enforces Drizzle safety rules (require WHERE on delete/update)
- Form validation schemas go in `_validation/` folders next to page components
